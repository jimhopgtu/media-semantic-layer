version: 2

models:
  - name: dim_articles
    description: |
      Article dimension table containing all article metadata with derived classifications.
      This is a Type 1 SCD (updates in place) as we don't need historical article attribute tracking.
      
      **Grain:** One row per article
      
      **Key Business Rules:**
      - Content length buckets based on word count thresholds
      - RPM tier classification for revenue analysis
      - Quality score derived from AI sentiment (prevents clickbait optimization)
      
    columns:
      - name: article_id
        description: Primary key - unique identifier for each article
        tests:
          - unique
          - not_null
          
      - name: title
        description: Article headline/title
        tests:
          - not_null
          
      - name: writer_id
        description: Foreign key to dim_writers
        tests:
          - not_null
          - relationships:
              to: ref('dim_writers')
              field: writer_id
              
      - name: publish_date
        description: Date article was published
        tests:
          - not_null
          
      - name: category
        description: Content category (sports, finance, lifestyle, news, opinion)
        tests:
          - not_null
          - accepted_values:
              values: ['sports', 'finance', 'lifestyle', 'news', 'opinion']
              
      - name: word_count
        description: Total word count of article content
        tests:
          - not_null
          
      - name: content_length_bucket
        description: |
          Derived classification:
          - short: < 500 words
          - medium: 500-999 words  
          - long: 1000-1999 words
          - very_long: 2000+ words
        tests:
          - not_null
          - accepted_values:
              values: ['short', 'medium', 'long', 'very_long']
              
      - name: is_premium
        description: Boolean flag indicating if article is behind paywall
        tests:
          - not_null
          
      - name: estimated_rpm
        description: Estimated revenue per thousand impressions (RPM) for this article
        tests:
          - not_null
          
      - name: rpm_tier
        description: |
          Revenue tier classification:
          - high: RPM >= 8.0
          - medium: 5.0 <= RPM < 8.0
          - low: RPM < 5.0
        tests:
          - not_null
          - accepted_values:
              values: ['high', 'medium', 'low']
              
      - name: is_evergreen
        description: Boolean indicating if content is still relevant after 30+ days
        tests:
          - not_null
          
      - name: sentiment_label
        description: AI-generated sentiment classification (POSITIVE, NEGATIVE, NEUTRAL)
        
      - name: quality_score
        description: |
          Composite quality metric (0-1) derived from sentiment.
          Used to prevent clickbait optimization in experiments.
          - POSITIVE sentiment: uses positive score
          - NEGATIVE sentiment: uses (1 - negative score)
          - NEUTRAL/missing: defaults to 0.5
          
      - name: dim_updated_at
        description: Timestamp when dimension record was last updated
        tests:
          - not_null

  - name: dim_writers
    description: |
      Writer dimension table containing all writer profiles and derived classifications.
      Type 1 SCD - we don't track historical changes to writer attributes.
      
      **Grain:** One row per writer
      
      **Key Business Rules:**
      - Experience levels based on tenure months
      - Productivity tiers based on article quotas
      
    columns:
      - name: writer_id
        description: Primary key - unique identifier for each writer
        tests:
          - unique
          - not_null
          
      - name: writer_name
        description: Full name of the writer
        tests:
          - not_null
          
      - name: primary_category
        description: Main content category this writer covers
        tests:
          - not_null
          - accepted_values:
              values: ['sports', 'finance', 'lifestyle', 'news', 'opinion']
              
      - name: tenure_start_date
        description: Date writer began working with organization
        tests:
          - not_null
          
      - name: contract_type
        description: Employment classification (staff, freelance, contractor)
        tests:
          - not_null
          - accepted_values:
              values: ['staff', 'freelance', 'contractor']
              
      - name: target_articles_per_month
        description: Expected monthly article output for this writer
        tests:
          - not_null
          
      - name: tenure_months
        description: Number of complete months since tenure_start_date
        tests:
          - not_null
          
      - name: experience_level
        description: |
          Derived classification based on tenure:
          - new: < 6 months
          - established: 6-23 months
          - veteran: 24+ months
        tests:
          - not_null
          - accepted_values:
              values: ['new', 'established', 'veteran']
              
      - name: employment_category
        description: |
          Simplified employment grouping:
          - full_time: staff
          - flexible: freelance or contractor
        tests:
          - not_null
          - accepted_values:
              values: ['full_time', 'flexible', 'other']
              
      - name: productivity_tier
        description: |
          Classification based on article targets:
          - high_volume: 20+ articles/month
          - medium_volume: 10-19 articles/month
          - low_volume: < 10 articles/month
        tests:
          - not_null
          - accepted_values:
              values: ['high_volume', 'medium_volume', 'low_volume']

  - name: fct_article_events
    description: |
      Fact table capturing all user interactions with articles at event grain.
      This is the primary analytics table for engagement, revenue, and experimentation analysis.
      
      **Grain:** One row per event (user + article + timestamp)
      
      **Key Metrics:**
      - Engagement flags (standard and high engagement thresholds)
      - Revenue estimates (based on RPM)
      - Quality-adjusted engagement (prevents clickbait optimization)
      
      **Important:** Quality-adjusted engagement only counts if user is engaged AND 
      multiplies by sentiment quality score to penalize low-quality but engaging content.
      
    columns:
      - name: user_pseudo_id
        description: Anonymous user identifier (part of composite grain)
        tests:
          - not_null
          
      - name: ga_session_id
        description: GA4 session identifier
        tests:
          - not_null
          
      - name: event_timestamp
        description: Exact timestamp of event (part of composite grain)
        tests:
          - not_null
          
      - name: event_name
        description: Type of event (page_view, scroll, user_engagement, click, view_item)
        tests:
          - not_null
          - accepted_values:
              values: ['page_view', 'scroll', 'user_engagement', 'click', 'view_item']
              
      - name: article_id
        description: Foreign key to dim_articles
        tests:
          - not_null
          - relationships:
              to: ref('dim_articles')
              field: article_id
              
      - name: writer_id
        description: Foreign key to dim_writers
        tests:
          - relationships:
              to: ref('dim_writers')
              field: writer_id
              
      - name: engagement_time_msec
        description: Time user spent on article in milliseconds
        
      - name: percent_scrolled
        description: Percentage of article user scrolled through (0-100)
        
      - name: is_engaged
        description: |
          Boolean engagement flag (1/0):
          - User spent 60+ seconds on article, OR
          - User scrolled 75%+ of article
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]
              
      - name: is_highly_engaged
        description: |
          Boolean high engagement flag (1/0):
          - User spent 3+ minutes on article, OR
          - User scrolled 90%+ of article
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]
              
      - name: estimated_revenue
        description: Estimated revenue for this event (RPM / 1000)
        
      - name: quality_adjusted_engagement
        description: |
          Quality-weighted engagement score (0-1):
          - 0 if user not engaged
          - sentiment quality_score if user is engaged
          
          This metric prevents optimizing for clickbait headlines that get clicks
          but don't deliver quality content. Used as primary metric in experiments.
          
      - name: event_date
        description: Date partition for the event
        tests:
          - not_null
          
      - name: device_category
        description: Device type (desktop, mobile, tablet)
        tests:
          - accepted_values:
              values: ['desktop', 'mobile', 'tablet']
              
      - name: article_category
        description: Content category from article dimension
        
      - name: content_length_bucket
        description: Article length classification from article dimension
        
      - name: rpm_tier
        description: Revenue tier from article dimension
        
      - name: writer_experience_level
        description: Writer experience classification from writer dimension

  - name: dim_experiments
    description: |
      PLACEHOLDER dimension for experiments (Week 2).
      Currently returns no rows. Will be fully implemented when experimentation
      data is added to the pipeline.
      
    columns:
      - name: experiment_id
        description: Primary key - unique identifier for each experiment
        
      - name: experiment_name
        description: Human-readable name for the experiment

  - name: mart_article_performance
    description: |
      Daily aggregated article performance metrics. This is the main table for 
      article-level analytics and dashboard queries.
      
      **Grain:** One row per article per day
      
      **Use Cases:**
      - Article performance dashboards
      - Content strategy analysis
      - A/B test result analysis
      - Trending content identification
      
      **Key Business Logic:**
      - Engagement rate = engaged users / unique viewers
      - Quality engagement rate accounts for content sentiment
      - Content age buckets track decay over time
      
    columns:
      - name: article_id
        description: Foreign key to dim_articles
        tests:
          - not_null
          - relationships:
              to: ref('dim_articles')
              field: article_id
              
      - name: event_date
        description: Date of the metrics (part of grain)
        tests:
          - not_null
          
      - name: unique_viewers
        description: Distinct users who viewed this article on this date
        tests:
          - not_null
          
      - name: engaged_users
        description: Distinct users who were engaged (60s+ or 75%+ scroll)
        
      - name: engagement_rate
        description: |
          Percentage of viewers who engaged (engaged_users / unique_viewers).
          Primary success metric for content performance.
        
      - name: quality_engagement_rate
        description: |
          Quality-adjusted engagement rate that prevents clickbait optimization.
          Takes sentiment quality into account.
          
      - name: total_revenue
        description: Total estimated revenue from this article on this date
        
      - name: revenue_per_viewer
        description: Average revenue per unique viewer
        
      - name: actual_rpm
        description: Actual RPM achieved (may differ from estimated_rpm)
        
      - name: avg_engagement_seconds
        description: Average time users spent on article
        
      - name: avg_scroll_percent
        description: Average scroll depth percentage
        
      - name: days_since_publish
        description: Number of days between publish date and event date
        
      - name: content_age_bucket
        description: |
          Age classification for content freshness analysis:
          - week_1: 0-7 days
          - week_2_to_4: 8-30 days
          - month_2_to_3: 31-90 days
          - older: 90+ days
          
      - name: mobile_pct
        description: Percentage of traffic from mobile devices
        
      - name: desktop_pct
        description: Percentage of traffic from desktop devices

  - name: mart_writer_performance
    description: |
      Weekly writer performance scorecards. Mirrors The Arena Group's writer 
      profitability analytics system.
      
      **Grain:** One row per writer per week
      
      **Use Cases:**
      - Writer productivity tracking
      - Compensation/bonus calculations
      - Editorial strategy (which writers to assign to what content)
      - Writer development/coaching
      
      **Key Business Logic:**
      - Revenue per article = primary profitability metric
      - Productivity status tracks against monthly targets
      - Quality tier identifies writers needing improvement
      
    columns:
      - name: writer_id
        description: Foreign key to dim_writers
        tests:
          - not_null
          - relationships:
              to: ref('dim_writers')
              field: writer_id
              
      - name: week_start_date
        description: Start of the week (Monday) for this scorecard
        tests:
          - not_null
          
      - name: articles_published
        description: Number of distinct articles published this week
        tests:
          - not_null
          
      - name: unique_viewers
        description: Total distinct users across all articles this week
        
      - name: engaged_users
        description: Total distinct engaged users across all articles
        
      - name: engagement_rate
        description: Percentage of viewers who engaged with writer's content
        
      - name: revenue_per_article
        description: |
          Average revenue per article. Key profitability metric used for 
          writer performance evaluation and compensation decisions.
          
      - name: avg_viewers_per_article
        description: Average audience reach per article
        
      - name: quality_engagement_rate
        description: |
          Quality-adjusted engagement rate. Writers with low scores may be
          optimizing for clicks over content quality.
          
      - name: productivity_status
        description: |
          Tracks against monthly article targets:
          - on_target: Meeting or exceeding quota
          - slightly_below: 80-99% of target
          - below_target: < 80% of target
        tests:
          - accepted_values:
              values: ['on_target', 'slightly_below', 'below_target']
              
      - name: quality_tier
        description: |
          Content quality classification based on quality-adjusted engagement:
          - high_quality: >= 0.35
          - good_quality: 0.25-0.34
          - acceptable_quality: 0.15-0.24
          - needs_improvement: < 0.15
        tests:
          - accepted_values:
              values: ['high_quality', 'good_quality', 'acceptable_quality', 'needs_improvement']
              
      - name: premium_article_pct
        description: Percentage of articles that are premium/paywalled
        
      - name: long_form_pct
        description: Percentage of articles that are long-form (1000+ words)

  - name: mart_engagement_summary
    description: |
      Pre-aggregated weekly engagement metrics by category, device, and traffic source.
      Optimized for fast dashboard filtering and trending analysis.
      
      **Grain:** One row per week × category × device × traffic_medium
      
      **Use Cases:**
      - Executive dashboards (fast queries)
      - Category performance comparison
      - Device optimization analysis
      - Traffic source attribution
      - Trend analysis over time
      
      **Performance Note:** This table is pre-aggregated to make dashboard 
      queries extremely fast, especially with multiple filters applied.
      
    columns:
      - name: week_start_date
        description: Start of the week (Monday)
        tests:
          - not_null
          
      - name: article_category
        description: Content category
        tests:
          - not_null
          
      - name: device_category
        description: Device type (desktop, mobile, tablet)
        tests:
          - not_null
          
      - name: traffic_medium
        description: Traffic source medium (organic, social, email, none)
        tests:
          - not_null
          
      - name: distinct_articles
        description: Number of unique articles in this segment
        
      - name: unique_users
        description: Number of unique users in this segment
        
      - name: engagement_rate
        description: Percentage of users who engaged
        
      - name: quality_engagement_rate
        description: Quality-adjusted engagement rate for this segment
        
      - name: avg_engagement_seconds
        description: Average engagement time in seconds
        
      - name: total_revenue
        description: Total revenue for this segment
        
      - name: revenue_per_user
        description: Average revenue per user
        
      - name: effective_rpm
        description: Actual RPM achieved in this segment
        
      - name: events_per_session
        description: Average events per session (stickiness metric)
        
      - name: premium_pct
        description: Percentage of events from premium content
        
      - name: long_form_pct
        description: Percentage of events from long-form content