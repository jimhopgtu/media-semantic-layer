# Semantic Models define the entities, dimensions, and measures for metrics
# Updated for dbt 1.11 - references marts layer tables

version: 2

semantic_models:
  - name: article_events
    description: >
      Fact table of all user interactions with articles. Primary table for 
      calculating engagement metrics and experimentation analysis.
    model: ref('fct_article_events')
    defaults:
      agg_time_dimension: event_date
    
    # Entities define the grain and relationships
    entities:
      - name: article
        type: foreign
        expr: article_id
      - name: writer
        type: foreign
        expr: writer_id
      - name: user
        type: foreign
        expr: user_pseudo_id
      - name: session
        type: foreign
        expr: ga_session_id
      - name: event
        type: primary
        expr: event_id
    
    # Dimensions for slicing and filtering
    dimensions:
      - name: event_date
        type: time
        type_params:
          time_granularity: day
      - name: event_timestamp
        type: time
        type_params:
          time_granularity: second
      - name: event_name
        type: categorical
      - name: device_category
        type: categorical
      - name: device_os
        type: categorical
      - name: device_browser
        type: categorical
      - name: geo_country
        type: categorical
      - name: geo_region
        type: categorical
      - name: traffic_source
        type: categorical
      - name: traffic_medium
        type: categorical
      - name: category
        type: categorical
        description: "Article content category"
      - name: is_premium
        type: categorical
      - name: writer_category
        type: categorical
        description: "Writer's primary content category"
      - name: contract_type
        type: categorical
        description: "Writer employment type"
    
    # Measures are aggregations that become building blocks for metrics
    measures:
      - name: total_events
        description: Count of all events
        agg: count
        expr: "1"
      - name: pageviews
        description: Count of page_view events
        agg: count
        expr: "CASE WHEN event_name = 'page_view' THEN 1 END"
      - name: engaged_events
        description: Count of events where user was engaged (60+ sec OR 75%+ scroll)
        agg: count
        expr: "CASE WHEN is_engaged THEN 1 END"
      - name: unique_users
        description: Distinct count of users
        agg: count_distinct
        expr: user_pseudo_id
      - name: unique_sessions
        description: Distinct count of sessions
        agg: count_distinct
        expr: ga_session_id
      - name: total_engagement_time_sec
        description: Sum of engagement time in seconds
        agg: sum
        expr: engagement_time_sec
      - name: total_revenue_estimate
        description: Sum of estimated revenue
        agg: sum
        expr: revenue_estimate
      - name: avg_engagement_time_sec
        description: Average engagement time in seconds
        agg: average
        expr: engagement_time_sec

  - name: articles
    description: >
      Dimension table for article attributes including AI sentiment scores.
    model: ref('dim_articles')
    defaults:
      agg_time_dimension: publish_date
    
    entities:
      - name: article
        type: primary
        expr: article_id
      - name: writer
        type: foreign
        expr: writer_id
    
    dimensions:
      - name: article_id
        type: categorical
      - name: title
        type: categorical
      - name: publish_date
        type: time
        type_params:
          time_granularity: day
      - name: category
        type: categorical
      - name: is_premium
        type: categorical
      - name: is_evergreen
        type: categorical
      - name: sentiment_label
        type: categorical
        description: AI-enriched sentiment (POSITIVE, NEGATIVE, NEUTRAL)
    
    measures:
      - name: article_count
        description: Count of articles
        agg: count
        expr: "1"
      - name: avg_word_count
        description: Average word count
        agg: average
        expr: word_count
      - name: avg_rpm
        description: Average revenue per thousand impressions
        agg: average
        expr: estimated_rpm

  - name: writers
    description: >
      Dimension table for writer attributes.
    model: ref('dim_writers')
    defaults:
      agg_time_dimension: tenure_start_date
    
    entities:
      - name: writer
        type: primary
        expr: writer_id
    
    dimensions:
      - name: writer_id
        type: categorical
      - name: writer_name
        type: categorical
      - name: primary_category
        type: categorical
      - name: contract_type
        type: categorical
      - name: tenure_start_date
        type: time
        type_params:
          time_granularity: day
    
    measures:
      - name: writer_count
        description: Count of writers
        agg: count
        expr: "1"
      - name: avg_tenure_months
        description: Average writer tenure in months
        agg: average
        expr: tenure_months
